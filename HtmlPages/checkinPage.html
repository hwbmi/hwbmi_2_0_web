<!-- Generated By dataTablesGen.xlsm -->
<div class='content container-fluid'>
  <!-- 標題 -->
  <div class='crms-title row bg-white'>
    <div class='col'>
      <h3 class='page-title m-0'>
        <span class='page-title-icon bg-gradient-primary text-white'>
          <i class='fa fa-user-circle' aria-hidden='true'></i> <!--icon 視需要修改-->
        </span>
        <span id='ml-報到填寫資料' style='font-size:22px'>報到填寫資料</span>
      </h3>
    </div>
  </div>

  <div style='margin: 20px'>
    <span style='margin-left:0px; font-size:20px; margin-right:70px' id ='ml-日期'>日期</span>
    <input style='font-size:20px; width:300px; border-width:2px; border-radius:8px' id='checkinDate' type='date' />
  </div>

  <button style='margin-left:10px' class='btn-gradient-primary font-weight-bold' onclick='genID()' >
    <span style="font-size:16px" id='ml-自動生成ID'>自動生成 ID</span>
  </button>
  <button style='margin-left:10px' class='btn-gradient-primary font-weight-bold' onclick='clearForm()' >
    <span style="font-size:16px" id='ml-清除資料'>清除資料</span>
  </button>  
  <div style='margin: 20px; margin-top:0px'>
    <span style='margin-left:0px; font-size:20px; margin-right: 2px' id ='ml-ID'>新 ID (必要)</span>
    <input style='font-size:20px; width:300px; border-radius:8px' id='userID' type='text' placeholder="10 位英數字，輸入後按 Enter" onchange="showBarcode()" />
    
<!--
    <button style='margin-left:10px' class='btn-gradient-primary font-weight-bold' onclick='genID()' >
      <span style="font-size:16px" id='ml-自動生成ID'>自動生成 ID</span>
    </button>
-->
        
    <span style="font-size:30px">&nbsp</span>
    
    <span id="barcode_and_button" style="display:none">
      <svg style='height:50px' id="barcode"></svg>

      <button style='margin-left:10px' class='btn-gradient-primary font-weight-bold' onclick='alert("Not implement yet")' >
        <span style="font-size:16px" id='ml-列印條碼'>列印條碼</span>
      </button> 
    </span>   
    
  </div>
 
  <div style='margin: 20px'>
    <span style='margin-left:0px; font-size:20px; margin-right: 27px' id ='ml-姓名'>客戶姓名</span>
    <input style='font-size:20px; width:300px; border-radius:8px' id='userName' type='text' placeholder=""/>
  </div>
  
  <div style='margin: 20px'>
    <span style='margin-left:0px; font-size:20px; margin-right: 10px' id ='ml-出生年月日'>出生年月日</span>
    <input style='font-size:20px; width:300px; border-width:2px; border-radius:8px' id='userBirth' type='date' />
  </div>
  
  <div style='margin: 20px'>
    <span style='margin-left:0px; font-size:20px; margin-right: 29px' id ='ml-手機號碼'>手機號碼</span>
    <input style='font-size:20px; width:300px; border-radius:8px' id='userPhone' type='text' placeholder="格式：09XXXXXXXX"/>
  </div>

  <div style='margin: 20px'>
    <span style='margin-left:0px; font-size:20px; margin-right: 69px' id ='ml-其他' >其他</span>
    <input style='font-size:20px; width:300px; border-radius:8px' id='others' type='text' placeholder="備註事項"/>
  </div>
    
  <div style="margin-top:50px">
    <button style='margin-left:10px; width:190px; font-size:16px' class='btn-gradient-primary font-weight-bold' onclick='saveUser()' >
      <span id='ml-儲存用戶資料'>儲存用戶資料</span>
    </button>
    <button style='margin-left:40px; width:190px; font-size:16px' class='btn-gradient-primary font-weight-bold' onclick='queryUser()' >
      <span id='ml-查詢用戶資料'>查詢用戶資料</span>
    </button>    
  </div>
  
  <script>
    var lastID = "1669257561";
    var initBirth = new Date("1996-01-01");
    var oldestBirth = new Date("1900-01-01");
    var checkExistID = true;
    
    $('#checkinDate').val(today.toISOString().substr(0,10));
    $('#userBirth').val(initBirth.toISOString().substr(0,10));
    
    function checkUserExist(){
      if (users.length==0) return false;

      // sync operations, working.
      for (var i=0; i< users.length; i++) {
        console.log(users[i]);
        if (users[i].id == $("#userID").val()) {
          return(true);
        }
      };

      // async operations, not owrking.
//      users.forEach( function (user) {
//        console.log(user.id);
//        if (user.id == $("#userID").val()) {
//          return(false);
//        } 
//      });

      
      return false;
    }
    
    function validUserData(){

      if ($("#userID").val().length==0) {
        alert("ID 為必要欄位");
        return false;
      }
      
      if ( ($("#userBirth").val().length>0) && 
           ($("#userBirth").val()>today.toISOString().substr(0,10)) ) {
        alert("生日不得在今天之後");
        return false;
      }

      if ( ($("#userBirth").val().length>0) && 
           ($("#userBirth").val()< oldestBirth.toISOString().substr(0,10)) ) {
        alert("生日不得在西元 1900 年之前");
        return false;
      }
      
      if ($("#userPhone").val().length>0) {
        if ($("#userPhone").val().match(/\d/g)==null){
          alert("手機號碼需要 10 位數字");
          return false;
        }  
        
        if ($("#userPhone").val().match(/\d/g).length !=10){
          alert("手機號碼需要 10 位數字");
          return false;
        }
      }
      
      return true;
    }
    
    function saveUser(){
      if (checkUserExist()){
        alert("用戶 ID:"+$("#userID").val()+ " 已存在！")
        $("#userID").val("");
        //TODO: Edit exist user
        
        return;
      }
      
      if (validUserData()) {
        users.push(
          {"id":$("#userID").val(),
           "create_at": $('#checkinDate').val(),
           "name": $("#userName").val(),
           "birth": $("#userBirth").val(),
           "phone": $("#userPhone").val(),
           "others": $("#others").val()
          }
        );
        
        //cal API to write
        //{"id":$("#userID").val(),
        // "create_at": $('#checkinDate').val(),
        // "name": $("#userName").val(),
        // "birth": $("#userBirth").val(),
        // "phone": $("#userPhone").val(),
        // "others": $("#others").val()
        //}

        //$("#userID").val("");
        $("#userName").val("");
        $("#userBirth").val(initBirth.toISOString().substr(0,10));
        $("#userPhone").val("");
        $("#others").val("");  
        
        $("#barcode_and_button").hide();
          
        alert($("#userID").val()+" 的用戶資料已儲存");
        $("#userID").val("");
      }
    }
    
    function queryUser(){
      if (users.length==0) {
        alert("資料庫為空白！");
        return false;
      }
      
      if ( ($("#userName").val().length==0) &&
           ($("#userPhone").val().length==0) 
         ) {
        alert("請輸入 姓名 或 手機號碼 進行查詢！");
        return false;        
      }
      
      // sync operations, working.
      var mached=false;
      for (var i=0; i< users.length; i++) {
        //console.log(users[i]);
        if ( (((users[i].name.toLowerCase().includes($("#userName").val().toLowerCase()))) && ($("#userName").val().length!=0))    ||
             (((users[i].phone.toLowerCase().includes($("#userPhone").val().toLowerCase()))) && ($("#userPhone").val().length!=0))          
            ){
          alert("找到用戶 ID:"+users[i].id);
          $("#userID").val(users[i].id);
          $("#userName").val(users[i].name);
          $("#userBirth").val(users[i].birth);
          $("#userPhone").val(users[i].phone);
          $("#others").val(users[i].others); 
          
          checkExistID = false;
          showBarcode();
          mached=true;
        }
      };
      
      checkExistID = true;
      if (!mached) alert("找不到符合的用戶");
    }
    
    function showBarcode(){
      if ($("#userID").val().length==0) {
        $("#barcode_and_button").hide();
      } else {
        if ( checkExistID && checkUserExist()) {
          alert("用戶 ID:"+$("#userID").val()+ " 已存在！");
          $("#userID").val("");
          $("#barcode_and_button").hide();
        }
        JsBarcode("#barcode", $("#userID").val(), {height:30, displayValue:true});
        $("#barcode_and_button").show();
      }
      
      checkExistID = true;
    }

    function genID(){
      var timestamp = Date.now().toString();
      var newID = timestamp.substr(0,10);
//      if (newID == lastID) {
//        alert("點擊太快造成 ID 重複，請重新生成 ID");
//        newID = "";
//        $("#userID").val(newID); 
//        $("#barcode").hide();
//        return;
//      }

      $("#barcode").show();
      $("#userID").val(newID);  
      lastID = newID;  

      showBarcode();

      console.log(lastID);
    }    
    
    function clearForm(){
        $("#userID").val("");
        $("#userName").val("");
        $("#userBirth").val(initBirth.toISOString().substr(0,10));
        $("#userPhone").val("");
        $("#others").val("");  
        
        $("#barcode_and_button").hide();   
    }
    

    
  </script>
      
</div>